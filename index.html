<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AVA Selecci√≥n</title>
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Inter', sans-serif;
  background: #f5f5f5;
}
@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
@keyframes slideUp {
  from { transform: translateY(30px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.15); }
}
::-webkit-scrollbar {
  width: 8px;
}
::-webkit-scrollbar-track {
  background: #f5f5f5;
  border-radius: 10px;
}
::-webkit-scrollbar-thumb {
  background: #FFC107;
  border-radius: 10px;
}
@media print {
  body * {
    visibility: hidden;
  }
  .print-content, .print-content * {
    visibility: visible;
  }
  .print-content {
    position: absolute;
    left: 0;
    top: 0;
  }
}
</style>
</head>
<body>
<div id="root"></div>
<script type="text/babel">
const { useState, useEffect } = React;

const BACKEND = {
  init() {
    if (!localStorage.getItem('ava_users')) {
      localStorage.setItem('ava_users', JSON.stringify([
        {
          id: 2,
          username: 'cliente1',
          password: 'cliente123',
          role: 'client',
          name: 'Restaurante El Teide',
          email: 'teide@rest.com',
          billingPreference: 'consolidated', // 'consolidated' o 'individual'
          restaurants: [
            { id: 1, name: 'El Teide - Tenerife Norte', island: 'tenerife', address: 'Santa Cruz de Tenerife' },
            { id: 2, name: 'El Teide - La Laguna', island: 'tenerife', address: 'San Crist√≥bal de La Laguna' }
          ]
        },
        {
          id: 3,
          username: 'cliente2',
          password: 'cliente123',
          role: 'client',
          name: 'Grupo Atl√°ntico',
          email: 'atlantico@rest.com',
          billingPreference: 'individual',
          restaurants: [
            { id: 3, name: 'Atl√°ntico - Las Palmas', island: 'gran_canaria', address: 'Las Palmas de Gran Canaria' },
            { id: 4, name: 'Atl√°ntico - Maspalomas', island: 'gran_canaria', address: 'Maspalomas' }
          ]
        }
      ]));
    }
    if (!localStorage.getItem('ava_orders')) localStorage.setItem('ava_orders', JSON.stringify([]));
    if (!localStorage.getItem('ava_invoices')) localStorage.setItem('ava_invoices', JSON.stringify([]));
    if (!localStorage.getItem('ava_favorites')) localStorage.setItem('ava_favorites', JSON.stringify({}));
  },
  login(u, p) {
    const users = JSON.parse(localStorage.getItem('ava_users') || '[]');
    const user = users.find(x => x.username === u && x.password === p);
    if (user) {
      const { password, ...userWithoutPassword } = user;
      localStorage.setItem('ava_current_user', JSON.stringify(userWithoutPassword));
      return { success: true, user: userWithoutPassword };
    }
    return { success: false, message: 'Usuario o contrase√±a incorrectos' };
  },
  logout() { localStorage.removeItem('ava_current_user'); },
  getCurrentUser() {
    const u = localStorage.getItem('ava_current_user');
    return u ? JSON.parse(u) : null;
  },
  updateBillingPreference(userId, preference) {
    const users = JSON.parse(localStorage.getItem('ava_users') || '[]');
    const updatedUsers = users.map(u => u.id === userId ? { ...u, billingPreference: preference } : u);
    localStorage.setItem('ava_users', JSON.stringify(updatedUsers));
    
    const currentUser = updatedUsers.find(u => u.id === userId);
    if (currentUser) {
      const { password, ...userWithoutPassword } = currentUser;
      localStorage.setItem('ava_current_user', JSON.stringify(userWithoutPassword));
    }
  },
  createOrder(order) {
    const orders = JSON.parse(localStorage.getItem('ava_orders') || '[]');
    const newOrder = { ...order, id: Date.now(), orderNumber: `PED-${Date.now()}`, createdAt: new Date().toISOString(), status: 'pending' };
    orders.push(newOrder);
    localStorage.setItem('ava_orders', JSON.stringify(orders));
    order.items.forEach(item => this.addToFavorites(order.userId, item.id));
    this.createInvoice(newOrder);
    return newOrder;
  },
  createInvoice(order) {
    const invoices = JSON.parse(localStorage.getItem('ava_invoices') || '[]');
    const newInvoice = {
      id: Date.now(),
      invoiceNumber: `FAC-${Date.now()}`,
      orderId: order.id,
      orderNumber: order.orderNumber,
      userId: order.userId,
      restaurantId: order.restaurantId,
      restaurant: order.restaurant,
      items: order.items,
      subtotal: order.subtotal,
      tax: order.tax,
      total: order.total,
      createdAt: new Date().toISOString(),
      status: 'pending'
    };
    invoices.push(newInvoice);
    localStorage.setItem('ava_invoices', JSON.stringify(invoices));
    return newInvoice;
  },
  getOrders(userId) {
    const orders = JSON.parse(localStorage.getItem('ava_orders') || '[]');
    return orders.filter(o => o.userId === userId).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  },
  getInvoices(userId, billingPreference) {
    const invoices = JSON.parse(localStorage.getItem('ava_invoices') || '[]');
    const userInvoices = invoices.filter(i => i.userId === userId);
    
    if (billingPreference === 'consolidated') {
      // Agrupar por mes
      const grouped = {};
      userInvoices.forEach(inv => {
        const date = new Date(inv.createdAt);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        if (!grouped[monthKey]) {
          grouped[monthKey] = {
            id: `consolidated-${monthKey}`,
            invoiceNumber: `FAC-CONS-${monthKey}`,
            month: monthKey,
            invoices: [],
            subtotal: 0,
            tax: 0,
            total: 0,
            createdAt: inv.createdAt,
            status: 'consolidated'
          };
        }
        grouped[monthKey].invoices.push(inv);
        grouped[monthKey].subtotal += inv.subtotal;
        grouped[monthKey].tax += inv.tax;
        grouped[monthKey].total += inv.total;
      });
      return Object.values(grouped).sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    } else {
      // Facturas individuales por restaurante
      return userInvoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
    }
  },
  getFavorites(userId) {
    const f = JSON.parse(localStorage.getItem('ava_favorites') || '{}');
    return f[userId] || [];
  },
  addToFavorites(userId, productId) {
    const f = JSON.parse(localStorage.getItem('ava_favorites') || '{}');
    if (!f[userId]) f[userId] = [];
    if (!f[userId].includes(productId)) {
      f[userId].push(productId);
      localStorage.setItem('ava_favorites', JSON.stringify(f));
    }
  },
  removeFromFavorites(userId, productId) {
    const f = JSON.parse(localStorage.getItem('ava_favorites') || '{}');
    if (f[userId]) {
      f[userId] = f[userId].filter(id => id !== productId);
      localStorage.setItem('ava_favorites', JSON.stringify(f));
    }
  }
};
BACKEND.init();

const ISLANDS = [
  { id: 'tenerife', name: 'Tenerife', deliveryDays: 'Martes y Viernes' },
  { id: 'gran_canaria', name: 'Gran Canaria', deliveryDays: 'Lunes y Jueves' }
];

const CATEGORIES = [
  { id: 'favorites', name: 'Mis Favoritos', description: 'Productos que has comprado anteriormente', image: 'https://images.unsplash.com/photo-1495195134817-aeb325a55b65?w=600&h=400&fit=crop' },
  { id: 'aceites', name: 'Aceites y Vinagres', description: 'Aceites premium y vinagres selectos', image: 'https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?w=600&h=400&fit=crop' },
  { id: 'condimentos', name: 'Condimentos y Especias', description: 'Sales, pimientas y especias del mundo', image: 'https://images.unsplash.com/photo-1596040033229-a0b3b46fe2b5?w=600&h=400&fit=crop' },
  { id: 'pasta', name: 'Pastas y Granos', description: 'Pastas artesanales y arroces especiales', image: 'https://images.unsplash.com/photo-1551462147-ff29053bfc14?w=600&h=400&fit=crop' }
];

const PRODUCTS = [
  { id: 1, name: "Aceite de Oliva Virgen Extra", code: "AOL-001", unit: "Litro", format: "Botella 1L", price: 24.50, category: 'aceites', image: "https://images.unsplash.com/photo-1474979266404-7eaacbcd87c5?w=400", description: "Aceite de oliva virgen extra de primera presi√≥n en fr√≠o.", techSheet: { origin: "Andaluc√≠a, Espa√±a", acidity: "0.2%", extraction: "Primera presi√≥n en fr√≠o" } },
  { id: 2, name: "Vinagre Bals√°mico de M√≥dena", code: "VIN-002", unit: "ml", format: "Botella 500ml", price: 18.90, category: 'aceites', image: "https://images.unsplash.com/photo-1609501676725-7186f017a4b7?w=400", description: "Vinagre bals√°mico tradicional envejecido 8 a√±os.", techSheet: { origin: "M√≥dena, Italia", aging: "8 a√±os", density: "1.28" } },
  { id: 3, name: "Sal Rosa del Himalaya", code: "SAL-003", unit: "Kg", format: "Bolsa 1Kg", price: 12.50, category: 'condimentos', image: "https://images.unsplash.com/photo-1607672632458-9eb56696346b?w=400", description: "Sal rosa pura del Himalaya, rica en minerales.", techSheet: { origin: "Punjab, Pakist√°n", purity: "98%", minerals: "84 minerales traza" } },
  { id: 4, name: "Pasta Artesanal Fusilli", code: "PAS-004", unit: "Kg", format: "Paquete 500g", price: 6.50, category: 'pasta', image: "https://images.unsplash.com/photo-1621996346565-e3dbc646d9a9?w=400", description: "Pasta artesanal de s√©mola de trigo duro.", techSheet: { origin: "Toscana, Italia", ingredients: "S√©mola de trigo duro", drying: "Secado lento 48h" } }
];

// ICONOS (los mismos del paso anterior)
const Heart = ({ size = 24, color = "currentColor", fill = "none" }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill={fill} stroke={color} strokeWidth="2">
    <path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"/>
  </svg>
);

const Plus = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const Minus = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="5" y1="12" x2="19" y2="12"/>
  </svg>
);

const ShoppingCart = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/>
    <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/>
  </svg>
);

const FileText = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
    <polyline points="14 2 14 8 20 8"/>
  </svg>
);

const User = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/>
  </svg>
);

const X = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
  </svg>
);

const MapPin = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/><circle cx="12" cy="10" r="3"/>
  </svg>
);

const Truck = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <rect x="1" y="3" width="15" height="13"/><polygon points="16 8 20 8 23 11 23 16 16 16 16 8"/>
    <circle cx="5.5" cy="18.5" r="2.5"/><circle cx="18.5" cy="18.5" r="2.5"/>
  </svg>
);

const Info = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="12" cy="12" r="10"/><line x1="12" y1="16" x2="12" y2="12"/>
    <line x1="12" y1="8" x2="12.01" y2="8"/>
  </svg>
);

const Package = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/>
    <polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/>
  </svg>
);

const Download = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/>
    <line x1="12" y1="15" x2="12" y2="3"/>
  </svg>
);

const Settings = ({ size = 24 }) => (
  <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
    <circle cx="12" cy="12" r="3"/><path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.4 6.4l-4.2-4.2M9.8 9.8 5.6 5.6m12.8 12.8l-4.2-4.2m-8.4 0l-4.2 4.2"/>
  </svg>
);

// Componentes anteriores (LoginScreen, Header, RestaurantModal, TechSheetModal, CategoriesView, ProductsView, OrdersView)
// ... (mantener los mismos del paso anterior)

function LoginScreen({ onLogin }) {
  const [username, setUsername] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const [loading, setLoading] = useState(false);

  const handleSubmit = (e) => {
    e.preventDefault();
    setLoading(true);
    setError('');
    setTimeout(() => {
      const result = BACKEND.login(username, password);
      if (result.success) onLogin(result.user);
      else setError(result.message);
      setLoading(false);
    }, 500);
  };

  return (
    <div style={{ minHeight: '100vh', display: 'flex', alignItems: 'center', justifyContent: 'center', background: 'linear-gradient(135deg, #1a1a1a, #2a2a2a)', padding: '2rem' }}>
      <div style={{ background: '#fff', borderRadius: '20px', boxShadow: '0 20px 60px rgba(0,0,0,0.3)', maxWidth: '450px', width: '100%', overflow: 'hidden', animation: 'slideUp 0.5s ease' }}>
        <div style={{ background: '#FFC107', padding: '2rem', textAlign: 'center' }}>
          <h1 style={{ fontSize: '2.5rem', fontWeight: '700', margin: '0 0 0.5rem 0', color: '#333' }}>AVA SELECCI√ìN</h1>
          <p style={{ margin: 0, color: '#333', fontSize: '0.95rem' }}>Consultor Gastron√≥mico</p>
        </div>
        <form onSubmit={handleSubmit} style={{ padding: '2rem' }}>
          <h2 style={{ fontSize: '1.5rem', marginBottom: '1.5rem', color: '#333', textAlign: 'center' }}>Iniciar Sesi√≥n</h2>
          {error && <div style={{ background: '#ffebee', color: '#c62828', padding: '1rem', borderRadius: '8px', marginBottom: '1rem', fontSize: '0.9rem' }}>{error}</div>}
          <div style={{ marginBottom: '1.5rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', color: '#333' }}>Usuario</label>
            <input type="text" value={username} onChange={(e) => setUsername(e.target.value)} required style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', outline: 'none' }} />
          </div>
          <div style={{ marginBottom: '2rem' }}>
            <label style={{ display: 'block', marginBottom: '0.5rem', fontWeight: '600', color: '#333' }}>Contrase√±a</label>
            <input type="password" value={password} onChange={(e) => setPassword(e.target.value)} required style={{ width: '100%', padding: '0.75rem', border: '2px solid #e0e0e0', borderRadius: '8px', fontSize: '1rem', outline: 'none' }} />
          </div>
          <button type="submit" disabled={loading} style={{ width: '100%', padding: '1rem', background: loading ? '#ccc' : '#FFC107', color: '#333', border: 'none', borderRadius: '8px', fontSize: '1.1rem', fontWeight: '700', cursor: loading ? 'not-allowed' : 'pointer' }}>
            {loading ? 'Iniciando...' : 'Iniciar Sesi√≥n'}
          </button>
          <div style={{ marginTop: '2rem', padding: '1rem', background: '#f8f8f8', borderRadius: '8px', fontSize: '0.85rem', color: '#666' }}>
            <strong style={{ display: 'block', marginBottom: '0.5rem', color: '#333' }}>Usuarios de prueba:</strong>
            <div><strong>Cliente 1:</strong> cliente1 / cliente123 (Facturas consolidadas)</div>
            <div><strong>Cliente 2:</strong> cliente2 / cliente123 (Facturas por restaurante)</div>
          </div>
        </form>
      </div>
    </div>
  );
}

function Header({ user, onLogout, currentView, setCurrentView, selectedRestaurant }) {
  return (
    <header style={{ background: '#fff', borderBottom: '1px solid #e0e0e0', position: 'sticky', top: 0, zIndex: 100 }}>
      <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '1rem 2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          <span style={{ fontSize: '1.5rem', fontWeight: '700', color: '#333' }}>AVA</span>
          <span style={{ fontSize: '0.85rem', color: '#999' }}>SELECCI√ìN</span>
        </div>
        <nav style={{ display: 'flex', gap: '0.5rem' }}>
          <button onClick={() => setCurrentView('catalog')} style={{ padding: '0.75rem 1.5rem', background: currentView === 'catalog' ? '#FFC107' : 'transparent', color: currentView === 'catalog' ? '#333' : '#666', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <ShoppingCart size={18} />Cat√°logo
          </button>
          <button onClick={() => setCurrentView('orders')} style={{ padding: '0.75rem 1.5rem', background: currentView === 'orders' ? '#FFC107' : 'transparent', color: currentView === 'orders' ? '#333' : '#666', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <Package size={18} />Mis Pedidos
          </button>
          <button onClick={() => setCurrentView('invoices')} style={{ padding: '0.75rem 1.5rem', background: currentView === 'invoices' ? '#FFC107' : 'transparent', color: currentView === 'invoices' ? '#333' : '#666', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
            <FileText size={18} />Facturas
          </button>
        </nav>
        <button onClick={onLogout} style={{ padding: '0.75rem 1.5rem', background: '#1a1a1a', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          <User size={18} />{selectedRestaurant ? selectedRestaurant.name : user.name}
        </button>
      </div>
    </header>
  );
}

function RestaurantModal({ user, selectedRestaurant, setSelectedRestaurant, onClose }) {
  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '2rem' }} onClick={onClose}>
      <div style={{ background: '#fff', borderRadius: '20px', maxWidth: '600px', width: '100%', animation: 'slideUp 0.3s ease' }} onClick={(e) => e.stopPropagation()}>
        <div style={{ background: '#FFC107', padding: '2rem', borderRadius: '20px 20px 0 0', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
          <h2 style={{ margin: 0, fontSize: '1.75rem', fontWeight: '700' }}>Selecciona un Restaurante</h2>
          <button onClick={onClose} style={{ background: 'rgba(0,0,0,0.1)', border: 'none', borderRadius: '50%', width: '36px', height: '36px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
            <X size={20} color="#333" />
          </button>
        </div>
        <div style={{ padding: '2rem' }}>
          {user.restaurants && user.restaurants.map(restaurant => (
            <button key={restaurant.id} onClick={() => { setSelectedRestaurant(restaurant); onClose(); }} style={{ width: '100%', padding: '1.5rem', background: selectedRestaurant?.id === restaurant.id ? '#FFF8E1' : '#f8f8f8', border: selectedRestaurant?.id === restaurant.id ? '2px solid #FFC107' : '2px solid #e0e0e0', borderRadius: '12px', marginBottom: '1rem', cursor: 'pointer', textAlign: 'left' }}>
              <div style={{ fontSize: '1.125rem', fontWeight: '700', color: '#333', marginBottom: '0.5rem' }}>{restaurant.name}</div>
              <div style={{ fontSize: '0.9rem', color: '#666', display: 'flex', alignItems: 'center', gap: '0.5rem', marginBottom: '0.25rem' }}>
                <MapPin size={16} />{restaurant.address}
              </div>
              <div style={{ fontSize: '0.9rem', color: '#FFC107', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Truck size={16} />{ISLANDS.find(i => i.id === restaurant.island)?.name} - Reparto: {ISLANDS.find(i => i.id === restaurant.island)?.deliveryDays}
              </div>
            </button>
          ))}
        </div>
      </div>
    </div>
  );
}

function TechSheetModal({ product, onClose }) {
  return (
    <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, background: 'rgba(0,0,0,0.6)', display: 'flex', alignItems: 'center', justifyContent: 'center', zIndex: 1000, padding: '2rem' }} onClick={onClose}>
      <div style={{ background: '#fff', borderRadius: '20px', maxWidth: '600px', width: '100%', maxHeight: '80vh', overflow: 'auto', animation: 'slideUp 0.3s ease' }} onClick={(e) => e.stopPropagation()}>
        <div style={{ position: 'relative', height: '200px', overflow: 'hidden' }}>
          <img src={product.image} alt={product.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
          <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, background: 'linear-gradient(to bottom,rgba(0,0,0,0.3),rgba(0,0,0,0.6))' }} />
          <button onClick={onClose} style={{ position: 'absolute', top: '1rem', right: '1rem', background: 'rgba(255,255,255,0.95)', border: 'none', borderRadius: '50%', width: '40px', height: '40px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
            <X size={20} color="#333" />
          </button>
          <div style={{ position: 'absolute', bottom: '1.5rem', left: '2rem', color: '#fff' }}>
            <h2 style={{ margin: '0 0 0.5rem 0', fontSize: '2rem', fontWeight: '700' }}>{product.name}</h2>
            <span style={{ padding: '0.375rem 0.875rem', background: 'rgba(255,255,255,0.25)', borderRadius: '20px', fontSize: '0.875rem' }}>{product.code}</span>
          </div>
        </div>
        <div style={{ padding: '2rem' }}>
          <div style={{ marginBottom: '2rem', paddingBottom: '2rem', borderBottom: '2px solid #e0e0e0' }}>
            <h3 style={{ fontSize: '1.25rem', color: '#333', marginBottom: '1rem', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <Info size={20} color="#FFC107" />Descripci√≥n
            </h3>
            <p style={{ fontSize: '1rem', lineHeight: '1.7', color: '#666' }}>{product.description}</p>
          </div>
          <div>
            <h3 style={{ fontSize: '1.25rem', color: '#333', marginBottom: '1.5rem', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <FileText size={20} color="#FFC107" />Ficha T√©cnica
            </h3>
            <div style={{ display: 'grid', gap: '1rem' }}>
              {Object.entries(product.techSheet).map(([key, value]) => (
                <div key={key} style={{ display: 'flex', padding: '1rem', background: '#f8f8f8', borderRadius: '12px', borderLeft: '4px solid #FFC107' }}>
                  <span style={{ fontWeight: '700', color: '#333', minWidth: '150px', textTransform: 'capitalize' }}>{key}:</span>
                  <span style={{ color: '#666', flex: 1 }}>{value}</span>
                </div>
              ))}
            </div>
          </div>
          <div style={{ marginTop: '2rem', padding: '1.5rem', background: '#FFF8E1', borderRadius: '12px', display: 'flex', justifyContent: 'space-between', alignItems: 'center', border: '2px solid #FFC107' }}>
            <div>
              <div style={{ fontSize: '0.875rem', color: '#666', marginBottom: '0.25rem' }}>Precio por {product.unit}</div>
              <div style={{ fontSize: '2.25rem', fontWeight: '700', color: '#FFC107' }}>‚Ç¨{product.price.toFixed(2)}</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function CategoriesView({ setSelectedCategory, favorites, selectedRestaurant, setShowRestaurantModal }) {
  return (
    <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '2rem' }}>
      <div style={{ background: '#fff', padding: '1.5rem', borderRadius: '12px', marginBottom: '2rem', boxShadow: '0 2px 8px rgba(0,0,0,0.05)', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
        <div>
          <div style={{ fontSize: '0.85rem', color: '#999', marginBottom: '0.25rem' }}>Pedido para:</div>
          <div style={{ fontSize: '1.25rem', fontWeight: '700', color: '#333', marginBottom: '0.25rem' }}>{selectedRestaurant ? selectedRestaurant.name : 'Selecciona un restaurante'}</div>
          {selectedRestaurant && (
            <div style={{ fontSize: '0.9rem', color: '#666', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
              <MapPin size={16} />{selectedRestaurant.address}
              <span style={{ marginLeft: '1rem', color: '#FFC107', fontWeight: '600' }}>
                <Truck size={16} style={{ display: 'inline', marginRight: '0.25rem' }} />
                {ISLANDS.find(i => i.id === selectedRestaurant.island)?.deliveryDays}
              </span>
            </div>
          )}
        </div>
        <button onClick={() => setShowRestaurantModal(true)} style={{ padding: '0.75rem 1.5rem', background: '#1a1a1a', color: '#fff', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>Cambiar Restaurante</button>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '1.5rem' }}>
        {CATEGORIES.map((cat, i) => (
          <div key={cat.id} onClick={() => setSelectedCategory(cat.id)} style={{ background: '#fff', borderRadius: '16px', overflow: 'hidden', cursor: 'pointer', boxShadow: '0 2px 8px rgba(0,0,0,0.08)', transition: 'all 0.3s', animation: `fadeIn 0.5s ease ${i * 0.1}s backwards` }} onMouseEnter={(e) => { e.currentTarget.style.transform = 'translateY(-8px)'; e.currentTarget.style.boxShadow = '0 12px 24px rgba(0,0,0,0.15)'; }} onMouseLeave={(e) => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.08)'; }}>
            <div style={{ position: 'relative', height: '180px', overflow: 'hidden' }}>
              <img src={cat.image} alt={cat.name} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
              <div style={{ position: 'absolute', top: 0, left: 0, right: 0, bottom: 0, background: 'linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.7))' }} />
              {cat.id === 'favorites' && favorites.length > 0 && (
                <div style={{ position: 'absolute', top: '1rem', right: '1rem', background: '#FFC107', color: '#333', padding: '0.5rem 1rem', borderRadius: '20px', fontSize: '0.85rem', fontWeight: '700' }}>
                  {favorites.length} producto{favorites.length !== 1 ? 's' : ''}
                </div>
              )}
            </div>
            <div style={{ padding: '1.5rem' }}>
              <h3 style={{ fontSize: '1.25rem', fontWeight: '700', color: '#333', marginBottom: '0.5rem' }}>{cat.name}</h3>
              <p style={{ fontSize: '0.9rem', color: '#666', lineHeight: '1.5' }}>{cat.description}</p>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function ProductsView({ productsToShow, selectedCategory, setSelectedCategory, favorites, toggleFavorite, addToCart, cart, updateQuantity, cartTotal, finishOrder, setShowTechSheet, setSelectedProduct }) {
  const currentCategory = CATEGORIES.find(c => c.id === selectedCategory);
  
  return (
    <div style={{ maxWidth: '1400px', margin: '0 auto', padding: '2rem' }}>
      <button onClick={() => setSelectedCategory(null)} style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', padding: '0.75rem 1.5rem', background: '#fff', border: '1px solid #e0e0e0', borderRadius: '8px', cursor: 'pointer', marginBottom: '2rem', fontWeight: '600', color: '#333' }}>
        ‚Üê Volver a Categor√≠as
      </button>

      <div style={{ background: '#fff', borderRadius: '16px', padding: '2rem', marginBottom: '2rem' }}>
        <h2 style={{ fontSize: '2rem', fontWeight: '700', color: '#333', marginBottom: '0.5rem' }}>{currentCategory?.name}</h2>
        <p style={{ color: '#666', fontSize: '1rem' }}>{currentCategory?.description}</p>
      </div>

      <div style={{ display: 'flex', gap: '2rem' }}>
        <div style={{ flex: 1 }}>
          {productsToShow.length === 0 ? (
            <div style={{ textAlign: 'center', padding: '4rem 2rem', background: '#fff', borderRadius: '16px' }}>
              <div style={{ fontSize: '4rem', marginBottom: '1rem' }}>{selectedCategory === 'favorites' ? '‚≠ê' : 'üîç'}</div>
              <h3 style={{ fontSize: '1.5rem', color: '#666' }}>{selectedCategory === 'favorites' ? 'No tienes favoritos a√∫n' : 'No hay productos'}</h3>
            </div>
          ) : (
            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(300px, 1fr))', gap: '1.5rem' }}>
              {productsToShow.map((p, idx) => (
                <div key={p.id} style={{ background: '#1a1a1a', borderRadius: '16px', overflow: 'hidden', transition: 'all 0.3s', animation: `fadeIn 0.5s ease ${idx * 0.05}s backwards` }} onMouseEnter={(e) => e.currentTarget.style.transform = 'translateY(-4px)'} onMouseLeave={(e) => e.currentTarget.style.transform = 'translateY(0)'}>
                  <div style={{ position: 'relative' }}>
                    <img src={p.image} alt={p.name} style={{ width: '100%', height: '200px', objectFit: 'cover' }} />
                    <button onClick={() => toggleFavorite(p.id)} style={{ position: 'absolute', top: '0.75rem', right: '0.75rem', background: favorites.includes(p.id) ? '#FFC107' : 'rgba(255,255,255,0.9)', border: 'none', borderRadius: '50%', width: '40px', height: '40px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer', animation: favorites.includes(p.id) ? 'pulse 0.5s ease' : 'none' }}>
                      <Heart size={20} color={favorites.includes(p.id) ? '#333' : '#666'} fill={favorites.includes(p.id) ? '#333' : 'none'} />
                    </button>
                    <button onClick={() => { setSelectedProduct(p); setShowTechSheet(true); }} style={{ position: 'absolute', top: '0.75rem', left: '0.75rem', background: '#FFC107', border: 'none', borderRadius: '50%', width: '40px', height: '40px', display: 'flex', alignItems: 'center', justifyContent: 'center', cursor: 'pointer' }}>
                      <FileText size={20} color="#333" />
                    </button>
                  </div>
                  <div style={{ padding: '1.25rem' }}>
                    <h3 style={{ fontSize: '1.125rem', fontWeight: '600', color: '#fff', marginBottom: '0.5rem' }}>{p.name}</h3>
                    <div style={{ display: 'flex', gap: '0.5rem', marginBottom: '0.75rem' }}>
                      <span style={{ fontSize: '0.75rem', padding: '0.25rem 0.75rem', background: '#2a2a2a', color: '#FFC107', borderRadius: '12px', fontWeight: '600' }}>{p.code}</span>
                      <span style={{ fontSize: '0.75rem', padding: '0.25rem 0.75rem', background: '#2a2a2a', color: '#aaa', borderRadius: '12px' }}>{p.format}</span>
                    </div>
                    <p style={{ fontSize: '0.875rem', color: '#999', marginBottom: '1rem' }}>{p.description}</p>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                      <div>
                        <div style={{ fontSize: '1.75rem', fontWeight: '700', color: '#FFC107' }}>‚Ç¨{p.price.toFixed(2)}</div>
                        <div style={{ fontSize: '0.75rem', color: '#666' }}>/{p.unit}</div>
                      </div>
                      <button onClick={() => addToCart(p)} style={{ background: '#FFC107', color: '#333', border: 'none', borderRadius: '12px', padding: '0.75rem 1.5rem', fontSize: '0.95rem', fontWeight: '700', cursor: 'pointer', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                        <Plus size={18} />A√±adir
                      </button>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>

        <div style={{ width: '350px' }}>
          <div style={{ background: '#fff', borderRadius: '16px', boxShadow: '0 4px 16px rgba(0,0,0,0.1)', position: 'sticky', top: '100px' }}>
            <div style={{ background: '#FFC107', padding: '1.5rem', borderRadius: '16px 16px 0 0' }}>
              <h3 style={{ margin: 0, fontWeight: '700', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <ShoppingCart size={20} />Carrito
              </h3>
            </div>
            <div style={{ padding: '1rem', maxHeight: '400px', overflowY: 'auto' }}>
              {cart.length === 0 ? (
                <div style={{ textAlign: 'center', padding: '2rem 1rem', color: '#999' }}>
                  <ShoppingCart size={48} color="#ccc" />
                  <p style={{ marginTop: '1rem' }}>Carrito vac√≠o</p>
                </div>
              ) : (
                cart.map(item => (
                  <div key={item.id} style={{ display: 'flex', gap: '1rem', padding: '1rem', background: '#f8f8f8', borderRadius: '12px', marginBottom: '0.75rem' }}>
                    <img src={item.image} alt={item.name} style={{ width: '60px', height: '60px', objectFit: 'cover', borderRadius: '8px' }} />
                    <div style={{ flex: 1 }}>
                      <h4 style={{ margin: '0 0 0.25rem 0', fontSize: '0.95rem', color: '#333' }}>{item.name}</h4>
                      <p style={{ margin: '0 0 0.5rem 0', fontSize: '0.85rem', color: '#666' }}>‚Ç¨{item.price.toFixed(2)}</p>
                      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '0.5rem', background: '#fff', borderRadius: '8px', padding: '0.25rem' }}>
                          <button onClick={() => updateQuantity(item.id, -1)} style={{ background: 'none', border: 'none', cursor: 'pointer', display: 'flex', padding: '0.25rem' }}>
                            <Minus size={16} />
                          </button>
                          <span style={{ minWidth: '24px', textAlign: 'center', fontWeight: '700', color: '#FFC107' }}>{item.quantity}</span>
                          <button onClick={() => updateQuantity(item.id, 1)} style={{ background: 'none', border: 'none', cursor: 'pointer', display: 'flex', padding: '0.25rem' }}>
                            <Plus size={16} />
                          </button>
                        </div>
                        <span style={{ fontWeight: '700', color: '#FFC107' }}>‚Ç¨{(item.price * item.quantity).toFixed(2)}</span>
                      </div>
                    </div>
                  </div>
                ))
              )}
            </div>
            {cart.length > 0 && (
              <div style={{ padding: '1.5rem', borderTop: '2px solid #e0e0e0' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', color: '#666' }}>
                  <span>Subtotal:</span><span>‚Ç¨{cartTotal.toFixed(2)}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem', color: '#666', fontSize: '0.9rem' }}>
                  <span>IGIC (7%):</span><span>‚Ç¨{(cartTotal * 0.07).toFixed(2)}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '1rem', fontWeight: '700', fontSize: '1.25rem' }}>
                  <span>Total:</span><span style={{ color: '#FFC107' }}>‚Ç¨{(cartTotal * 1.07).toFixed(2)}</span>
                </div>
                <button onClick={finishOrder} style={{ width: '100%', background: '#FFC107', color: '#333', border: 'none', borderRadius: '12px', padding: '1rem', fontSize: '1.1rem', fontWeight: '700', cursor: 'pointer' }}>
                  Finalizar Pedido
                </button>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  );
}

function OrdersView({ user }) {
  const [orders, setOrders] = useState([]);
  useEffect(() => { setOrders(BACKEND.getOrders(user.id)); }, [user.id]);
  
  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '2rem' }}>
      <h2 style={{ fontSize: '2rem', fontWeight: '700', marginBottom: '2rem', color: '#333' }}>Mis Pedidos</h2>
      {orders.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '4rem 2rem', background: '#fff', borderRadius: '16px' }}>
          <Package size={64} color="#ccc" />
          <h3 style={{ fontSize: '1.5rem', color: '#666', margin: '1rem 0' }}>No tienes pedidos a√∫n</h3>
        </div>
      ) : (
        orders.map(order => (
          <div key={order.id} style={{ background: '#fff', border: '1px solid #e0e0e0', borderRadius: '16px', marginBottom: '1.5rem', padding: '2rem', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
            <div style={{ fontSize: '1.25rem', fontWeight: '700', color: '#333', marginBottom: '0.5rem' }}>Pedido {order.orderNumber}</div>
            <div style={{ fontSize: '0.9rem', color: '#666', marginBottom: '1rem' }}>
              {new Date(order.createdAt).toLocaleDateString('es-ES', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
            </div>
            <div style={{ padding: '1rem', background: '#f8f8f8', borderRadius: '8px' }}>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                <span>Subtotal:</span><span>‚Ç¨{order.subtotal.toFixed(2)}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.5rem' }}>
                <span>IGIC (7%):</span><span>‚Ç¨{order.tax.toFixed(2)}</span>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: '0.5rem', borderTop: '2px solid #e0e0e0', fontSize: '1.25rem', fontWeight: '700' }}>
                <span>Total:</span><span style={{ color: '#FFC107' }}>‚Ç¨{order.total.toFixed(2)}</span>
              </div>
            </div>
          </div>
        ))
      )}
    </div>
  );
}

// ============ VISTA DE FACTURAS CON PREFERENCIA ============
function InvoicesView({ user, updateUserPreference }) {
  const [invoices, setInvoices] = useState([]);
  const [billingPreference, setBillingPreference] = useState(user.billingPreference || 'consolidated');
  const [showSettings, setShowSettings] = useState(false);

  useEffect(() => {
    setInvoices(BACKEND.getInvoices(user.id, billingPreference));
  }, [user.id, billingPreference]);

  const handlePreferenceChange = (newPreference) => {
    setBillingPreference(newPreference);
    BACKEND.updateBillingPreference(user.id, newPreference);
    updateUserPreference(newPreference);
    setInvoices(BACKEND.getInvoices(user.id, newPreference));
    setShowSettings(false);
  };

  const downloadInvoice = (invoice) => {
    window.print();
  };

  return (
    <div style={{ maxWidth: '1200px', margin: '0 auto', padding: '2rem' }}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '2rem' }}>
        <h2 style={{ fontSize: '2rem', fontWeight: '700', color: '#333' }}>Mis Facturas</h2>
        <button onClick={() => setShowSettings(!showSettings)} style={{ padding: '0.75rem 1.5rem', background: '#f8f8f8', border: '1px solid #e0e0e0', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
          <Settings size={18} />
          Configuraci√≥n
        </button>
      </div>

      {showSettings && (
        <div style={{ background: '#FFF8E1', border: '2px solid #FFC107', borderRadius: '12px', padding: '1.5rem', marginBottom: '2rem' }}>
          <h3 style={{ fontSize: '1.25rem', fontWeight: '700', marginBottom: '1rem', color: '#333' }}>Preferencia de Facturaci√≥n</h3>
          <div style={{ display: 'flex', gap: '1rem' }}>
            <button 
              onClick={() => handlePreferenceChange('consolidated')}
              style={{ 
                flex: 1, 
                padding: '1rem', 
                background: billingPreference === 'consolidated' ? '#FFC107' : '#fff', 
                border: billingPreference === 'consolidated' ? '2px solid #FFC107' : '2px solid #e0e0e0',
                borderRadius: '8px', 
                cursor: 'pointer', 
                fontWeight: '600',
                textAlign: 'left'
              }}
            >
              <div style={{ fontSize: '1rem', marginBottom: '0.25rem' }}>üìä Facturas Consolidadas</div>
              <div style={{ fontSize: '0.85rem', color: '#666' }}>Una factura mensual con todos los restaurantes</div>
            </button>
            <button 
              onClick={() => handlePreferenceChange('individual')}
              style={{ 
                flex: 1, 
                padding: '1rem', 
                background: billingPreference === 'individual' ? '#FFC107' : '#fff', 
                border: billingPreference === 'individual' ? '2px solid #FFC107' : '2px solid #e0e0e0',
                borderRadius: '8px', 
                cursor: 'pointer', 
                fontWeight: '600',
                textAlign: 'left'
              }}
            >
              <div style={{ fontSize: '1rem', marginBottom: '0.25rem' }}>üè™ Facturas por Restaurante</div>
              <div style={{ fontSize: '0.85rem', color: '#666' }}>Una factura individual por cada restaurante</div>
            </button>
          </div>
        </div>
      )}

      {invoices.length === 0 ? (
        <div style={{ textAlign: 'center', padding: '4rem 2rem', background: '#fff', borderRadius: '16px' }}>
          <FileText size={64} color="#ccc" />
          <h3 style={{ fontSize: '1.5rem', color: '#666', margin: '1rem 0' }}>No tienes facturas a√∫n</h3>
        </div>
      ) : (
        invoices.map(invoice => (
          <div key={invoice.id} style={{ background: '#fff', border: '2px solid #e0e0e0', borderRadius: '16px', overflow: 'hidden', marginBottom: '1.5rem', boxShadow: '0 2px 8px rgba(0,0,0,0.05)' }}>
            <div style={{ background: '#1a1a1a', color: '#fff', padding: '2rem', display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
              <div>
                <div style={{ fontSize: '1.5rem', fontWeight: '700', marginBottom: '0.5rem' }}>
                  {invoice.status === 'consolidated' ? 
                    `Factura Consolidada - ${new Date(invoice.createdAt).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' })}` : 
                    `Factura ${invoice.invoiceNumber}`
                  }
                </div>
                {invoice.status === 'consolidated' ? (
                  <div style={{ fontSize: '0.9rem', opacity: 0.8 }}>{invoice.invoices.length} pedido{invoice.invoices.length !== 1 ? 's' : ''} incluidos</div>
                ) : (
                  <div style={{ fontSize: '0.9rem', opacity: 0.8 }}>Pedido: {invoice.orderNumber} - {invoice.restaurant.name}</div>
                )}
              </div>
              <button onClick={() => downloadInvoice(invoice)} style={{ padding: '0.75rem 1.5rem', background: '#FFC107', color: '#333', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '700', display: 'flex', alignItems: 'center', gap: '0.5rem' }}>
                <Download size={18} />
                Descargar PDF
              </button>
            </div>
            <div style={{ padding: '2rem' }}>
              {invoice.status === 'consolidated' && (
                <div style={{ marginBottom: '1.5rem', padding: '1rem', background: '#f8f8f8', borderRadius: '8px' }}>
                  <h4 style={{ fontSize: '1rem', fontWeight: '700', marginBottom: '0.75rem', color: '#333' }}>Pedidos Incluidos:</h4>
                  {invoice.invoices.map(inv => (
                    <div key={inv.id} style={{ padding: '0.75rem', background: '#fff', borderRadius: '8px', marginBottom: '0.5rem', display: 'flex', justifyContent: 'space-between' }}>
                      <span style={{ fontSize: '0.9rem' }}>{inv.restaurant.name} - {inv.orderNumber}</span>
                      <span style={{ fontSize: '0.9rem', fontWeight: '600', color: '#FFC107' }}>‚Ç¨{inv.total.toFixed(2)}</span>
                    </div>
                  ))}
                </div>
              )}
              <div style={{ background: '#FFF8E1', padding: '1.5rem', borderRadius: '12px', border: '2px solid #FFC107' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                  <span>Subtotal:</span><span>‚Ç¨{invoice.subtotal.toFixed(2)}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '0.75rem' }}>
                  <span>IGIC (7%):</span><span>‚Ç¨{invoice.tax.toFixed(2)}</span>
                </div>
                <div style={{ display: 'flex', justifyContent: 'space-between', paddingTop: '0.75rem', borderTop: '2px solid #FFC107', fontSize: '1.5rem', fontWeight: '700' }}>
                  <span>TOTAL:</span><span style={{ color: '#FFC107' }}>‚Ç¨{invoice.total.toFixed(2)}</span>
                </div>
              </div>
            </div>
          </div>
        ))
      )}
    </div>
  );
}

// ============ APP PRINCIPAL ============
function App() {
  const [currentUser, setCurrentUser] = useState(null);
  const [currentView, setCurrentView] = useState('catalog');
  const [selectedCategory, setSelectedCategory] = useState(null);
  const [selectedRestaurant, setSelectedRestaurant] = useState(null);
  const [favorites, setFavorites] = useState([]);
  const [cart, setCart] = useState([]);
  const [notification, setNotification] = useState(null);
  const [showRestaurantModal, setShowRestaurantModal] = useState(false);
  const [showTechSheet, setShowTechSheet] = useState(false);
  const [selectedProduct, setSelectedProduct] = useState(null);

  useEffect(() => {
    const user = BACKEND.getCurrentUser();
    if (user) {
      setCurrentUser(user);
      setFavorites(BACKEND.getFavorites(user.id));
      if (user.restaurants?.length > 0) setSelectedRestaurant(user.restaurants[0]);
    }
  }, []);

  const showNotif = (msg) => {
    setNotification(msg);
    setTimeout(() => setNotification(null), 3000);
  };

  const toggleFavorite = (productId) => {
    if (favorites.includes(productId)) {
      BACKEND.removeFromFavorites(currentUser.id, productId);
      setFavorites(favorites.filter(id => id !== productId));
      showNotif('Eliminado de favoritos');
    } else {
      BACKEND.addToFavorites(currentUser.id, productId);
      setFavorites([...favorites, productId]);
      showNotif('A√±adido a favoritos');
    }
  };

  const addToCart = (product) => {
    if (!selectedRestaurant) {
      showNotif('Selecciona un restaurante primero');
      return;
    }
    setCart(prev => {
      const existing = prev.find(item => item.id === product.id);
      if (existing) return prev.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
      return [...prev, { ...product, quantity: 1 }];
    });
    showNotif(`${product.name} a√±adido al carrito`);
  };

  const updateQuantity = (productId, delta) => {
    setCart(prev => {
      const updated = prev.map(item => item.id === productId ? { ...item, quantity: Math.max(0, item.quantity + delta) } : item);
      return updated.filter(item => item.quantity > 0);
    });
  };

  const finishOrder = () => {
    if (cart.length === 0) { showNotif('El carrito est√° vac√≠o'); return; }
    if (!selectedRestaurant) { showNotif('Selecciona un restaurante'); return; }
    
    const subtotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
    const order = {
      userId: currentUser.id,
      restaurantId: selectedRestaurant.id,
      restaurant: selectedRestaurant,
      island: selectedRestaurant.island,
      items: cart,
      subtotal,
      tax: subtotal * 0.07,
      total: subtotal * 1.07
    };
    
    BACKEND.createOrder(order);
    setFavorites(BACKEND.getFavorites(currentUser.id));
    setCart([]);
    showNotif('¬°Pedido realizado! Productos a√±adidos a favoritos');
  };

  const handleLogin = (user) => {
    setCurrentUser(user);
    setFavorites(BACKEND.getFavorites(user.id));
    if (user.restaurants?.length > 0) setSelectedRestaurant(user.restaurants[0]);
  };

  const handleLogout = () => {
    BACKEND.logout();
    window.location.reload();
  };

  const updateUserPreference = (preference) => {
    setCurrentUser({ ...currentUser, billingPreference: preference });
  };

  if (!currentUser) return <LoginScreen onLogin={handleLogin} />;

  let productsToShow = [];
  if (selectedCategory) {
    productsToShow = selectedCategory === 'favorites' ? PRODUCTS.filter(p => favorites.includes(p.id)) : PRODUCTS.filter(p => p.category === selectedCategory);
  }
  const cartTotal = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);

  return (
    <div style={{ minHeight: '100vh', background: '#f5f5f5' }}>
      <Header user={currentUser} onLogout={handleLogout} currentView={currentView} setCurrentView={setCurrentView} selectedRestaurant={selectedRestaurant} />

      {notification && (
        <div style={{ position: 'fixed', top: '100px', right: '2rem', background: '#FFC107', color: '#333', padding: '1rem 1.5rem', borderRadius: '12px', zIndex: 1000, fontWeight: '600', boxShadow: '0 4px 12px rgba(255,193,7,0.3)', animation: 'fadeIn 0.3s' }}>
          {notification}
        </div>
      )}

      {currentView === 'catalog' && (
        selectedCategory ? (
          <ProductsView productsToShow={productsToShow} selectedCategory={selectedCategory} setSelectedCategory={setSelectedCategory} favorites={favorites} toggleFavorite={toggleFavorite} addToCart={addToCart} cart={cart} updateQuantity={updateQuantity} cartTotal={cartTotal} finishOrder={finishOrder} setShowTechSheet={setShowTechSheet} setSelectedProduct={setSelectedProduct} />
        ) : (
          <CategoriesView setSelectedCategory={setSelectedCategory} favorites={favorites} selectedRestaurant={selectedRestaurant} setShowRestaurantModal={setShowRestaurantModal} />
        )
      )}

      {currentView === 'orders' && <OrdersView user={currentUser} />}
      {currentView === 'invoices' && <InvoicesView user={currentUser} updateUserPreference={updateUserPreference} />}

      {showRestaurantModal && currentUser.restaurants && (
        <RestaurantModal user={currentUser} selectedRestaurant={selectedRestaurant} setSelectedRestaurant={setSelectedRestaurant} onClose={() => setShowRestaurantModal(false)} />
      )}

      {showTechSheet && selectedProduct && (
        <TechSheetModal product={selectedProduct} onClose={() => setShowTechSheet(false)} />
      )}
    </div>
  );
}

ReactDOM.render(<App />, document.getElementById('root'));
</script>
</body>
</html>
